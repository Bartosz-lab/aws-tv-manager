---
- name: "Create subnets"
  amazon.aws.ec2_vpc_subnet:
    tags:
      Name: "Cloud TV VPN Subnet {{ item.name }}"
      Ansible: true
      Cloud-TV: true
    az: "{{ region }}{{ item.name }}"
    vpc_id: "{{ vpc_id }}"
    cidr: "{{ item.cidr }}"

  loop: "{{ az }}"
  register: subnets

- name: Create security group
  amazon.aws.ec2_security_group:
    tags:
      Name: Cloud TV VPN Security Group
      Ansible: true
      Cloud-TV: true
    name: Cloud TV VPN Security Group
    description: Allow inboud trafic to wireguard
    vpc_id: "{{ vpc_id }}"
    rules: 
      - proto: tcp
        from_port: "{{ wg_port }}"
        to_port: "{{ wg_port }}"
        cidr_ip: 0.0.0.0/0
        rule_desc: allow trafic to wireguard
  register: security_group

- name: Create Instances
  amazon.aws.ec2_instance:
    tags:
      Ansible: true
      Cloud-TV: true
      Role: wireguard
    name: "VPN Wireguard {{ item.item.name }}"
    key_name: "{{ key_name }}"
    vpc_subnet_id: "{{ item.subnet.id }}"
    instance_type: "{{ instance_type }}"
    security_groups: 
      - "{{ security_group.group_id }}"
      - "{{ security_group_management.group_id }}"
    image_id: "{{ image_id }}"
    state: running
  loop: "{{ subnets.results }}"
  loop_control:
        label: "{{ item.item.name }}"
  register: instances
      
- name: Create a target group for Load balancer
  community.aws.elb_target_group:
    tags:
      Ansible: true
      Cloud-TV: true
    name: "cloud-tv-vpn-tg"
    protocol: TCP
    target_type: "instance"
    port: "{{ wg_port }}"
    vpc_id: "{{ vpc_id }}"
    state: present
  register: target_group

- name: Add targets to target group
  community.aws.elb_target:
    target_group_name: "{{ target_group.target_group_name }}"
    target_id: "{{ item }}"
    state: present
  loop:  "{{ instances.results | map(attribute='instances') | flatten | map(attribute='instance_id') }}"

- name: Create Load balancer
  community.aws.elb_network_lb:
    tags:
      Name: "Cloud TV VPN LB"
      Ansible: true
      Cloud-TV: true
    name: "cloud-tv-vpn-lb"    
    cross_zone_load_balancing: true
    subnets: "{{ subnets.results | map(attribute='subnet.id') }}"
    listeners:
      - Protocol: TCP 
        Port: "{{ wg_port }}"
        DefaultActions:
          - Type: forward
            TargetGroupName: "{{ target_group.target_group_name }}"

